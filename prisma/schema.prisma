generator client {
  provider = "prisma-client"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum Role {
  SUPER_ADMIN
  MID_ADMIN
  MANAGER
  AGENT
}

enum Plan {
  TRIAL
  SMALL
  LARGE
}

enum SubStatus {
  ACTIVE
  GRACE
  LOCKED
  CANCELLED
}

enum TransactionType {
  SALE
  LONG_TERM_RENT
  SHORT_TERM_RENT
  PRE_SALE
}

enum PropertyType {
  APARTMENT
  HOUSE
  VILLA
  LAND
  COMMERCIAL
  OFFICE
  OTHER
}

enum FileStatus {
  ACTIVE
  ARCHIVED
  SOLD
  RENTED
  EXPIRED
}

enum ContactType {
  OWNER
  TENANT
  LANDLORD
  BUYER
}

enum CustomerType {
  BUYER
  RENTER
  SELLER
  LANDLORD
}

// ─── Models ───────────────────────────────────────────────────────────────────

// Office is the tenant root. Every other entity belongs to an office via officeId.
model Office {
  id           String        @id @default(cuid())
  name         String
  // Referral code entered at registration — identifies the referrer, not this office.
  referralCode String?
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  users        User[]
  subscription Subscription?
  files        PropertyFile[]
  customers    Customer[]
  contracts    Contract[]

  @@map("offices")
}

model User {
  id           String        @id @default(cuid())
  // username is the primary login identifier. Unique globally across all offices.
  username     String        @unique
  // email is optional — agents may have no email. Nullable unique allows multiple NULLs in PostgreSQL.
  email        String?       @unique
  passwordHash String
  displayName  String
  role         Role
  isActive     Boolean       @default(true)
  // avatarUrl will be populated by the image processing pipeline (Feature 14)
  avatarUrl    String?
  officeId     String
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  office              Office           @relation(fields: [officeId], references: [id])
  sessions            UserSession[]
  createdFiles        PropertyFile[]   @relation("CreatedFiles")
  fileAssignments     FileAssignment[]
  activityLogs        ActivityLog[]
  priceHistory        PriceHistory[]
  shareLinks          ShareLink[]
  notifications       Notification[]
  createdCustomers    Customer[]       @relation("CreatedCustomers")
  customerNotes       CustomerNote[]   @relation("CustomerNotes")
  finalizedContracts  Contract[]       @relation("FinalizedContracts")

  @@map("users")
}

// Tracks active sessions per user. Used to enforce the 2-session limit.
// Does NOT replace the JWT — it is a secondary store for session counting and invalidation.
model UserSession {
  id        String   @id @default(cuid())
  userId    String
  // expiresAt matches the JWT maxAge (30 days). Used for automatic cleanup.
  expiresAt DateTime
  createdAt DateTime @default(now())

  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

// One subscription per office. Created automatically on registration (TRIAL plan).
model Subscription {
  id               String    @id @default(cuid())
  officeId         String    @unique
  plan             Plan      @default(TRIAL)
  status           SubStatus @default(ACTIVE)
  // trialEndsAt is set to now + 30 days at registration.
  trialEndsAt      DateTime
  // currentPeriodEnd is set when the office upgrades to a paid plan.
  currentPeriodEnd DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  office           Office    @relation(fields: [officeId], references: [id])

  @@map("subscriptions")
}

// A property listing (فایل). Minimum to create: transactionType + location + 1 contact.
model PropertyFile {
  id              String          @id @default(cuid())
  officeId        String
  createdById     String
  transactionType TransactionType
  status          FileStatus      @default(ACTIVE)
  propertyType    PropertyType?

  // Physical details
  area            Int?            // square meters (متراژ)
  floorNumber     Int?
  totalFloors     Int?
  buildingAge     Int?            // years (سن بنا)

  // Price fields — which are used depends on transactionType
  salePrice       Int?            // total price in Toman (for SALE, PRE_SALE)
  depositAmount   Int?            // رهن in Toman (for LONG_TERM_RENT)
  rentAmount      Int?            // monthly اجاره in Toman (for LONG_TERM_RENT, SHORT_TERM_RENT)

  // Location — map pin stored as lat/lng. Address filled manually until map feature is built.
  latitude        Float?
  longitude       Float?
  address         String?
  neighborhood    String?
  // Neshan POI analysis stored as JSON after location is pinned (Feature 13)
  locationAnalysis Json?

  // AI-generated or manually written description
  description     String?

  // Amenities
  hasElevator     Boolean         @default(false)
  hasParking      Boolean         @default(false)
  hasStorage      Boolean         @default(false)
  hasBalcony      Boolean         @default(false)
  hasSecurity     Boolean         @default(false)

  // Internal notes — not shown on public share page
  notes           String?

  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  office          Office          @relation(fields: [officeId], references: [id])
  createdBy       User            @relation("CreatedFiles", fields: [createdById], references: [id])
  assignedAgents  FileAssignment[]
  contacts        Contact[]
  photos          FilePhoto[]
  activityLogs    ActivityLog[]
  priceHistory    PriceHistory[]
  shareLinks      ShareLink[]
  contract        Contract?
  notifications   Notification[]

  @@index([officeId])
  @@index([officeId, status])
  @@map("property_files")
}

// Tracks which agents are assigned to a file.
model FileAssignment {
  id         String       @id @default(cuid())
  fileId     String
  userId     String
  assignedAt DateTime     @default(now())

  file       PropertyFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user       User         @relation(fields: [userId], references: [id])

  @@unique([fileId, userId])
  @@map("file_assignments")
}

// Contacts linked to a file (owner, tenant, buyer, landlord).
model Contact {
  id        String       @id @default(cuid())
  fileId    String
  type      ContactType
  name      String?
  phone     String
  notes     String?
  createdAt DateTime     @default(now())

  file      PropertyFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@map("contacts")
}

// Photo records for a file. URL points to IranServer object storage (Feature 14).
model FilePhoto {
  id        String       @id @default(cuid())
  fileId    String
  url       String
  order     Int          @default(0)
  createdAt DateTime     @default(now())

  file      PropertyFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  @@map("file_photos")
}

// Immutable log of all file changes. Visible to managers only.
model ActivityLog {
  id        String       @id @default(cuid())
  fileId    String
  userId    String
  // Human-readable action label: CREATE, EDIT, STATUS_CHANGE, ASSIGNMENT, SHARE_LINK
  action    String
  // Field-level diff stored as JSON: { field: [oldValue, newValue] }
  diff      Json?
  createdAt DateTime     @default(now())

  file      PropertyFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id])

  @@index([fileId])
  @@map("activity_logs")
}

// Records every price change on a file with before/after values.
model PriceHistory {
  id          String       @id @default(cuid())
  fileId      String
  changedById String
  // Which price field changed: salePrice | depositAmount | rentAmount
  priceField  String
  oldPrice    Int?
  newPrice    Int?
  changedAt   DateTime     @default(now())

  file        PropertyFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  changedBy   User         @relation(fields: [changedById], references: [id])

  @@index([fileId])
  @@map("price_history")
}

// CRM customer — a buyer, renter, seller, or landlord tracked by the office.
model Customer {
  id          String         @id @default(cuid())
  officeId    String
  createdById String
  name        String
  phone       String
  email       String?
  type        CustomerType
  // Internal notes about this customer
  notes       String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  office      Office         @relation(fields: [officeId], references: [id])
  createdBy   User           @relation("CreatedCustomers", fields: [createdById], references: [id])
  contactLogs CustomerNote[]

  @@index([officeId])
  @@map("customers")
}

// A timestamped interaction note logged against a customer.
model CustomerNote {
  id         String   @id @default(cuid())
  customerId String
  userId     String
  content    String
  createdAt  DateTime @default(now())

  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  user       User     @relation("CustomerNotes", fields: [userId], references: [id])

  @@index([customerId])
  @@map("customer_notes")
}

// A finalized deal. Created by the manager when a transaction closes.
// Creating a contract atomically transitions the file to SOLD or RENTED and
// deactivates all share links.
model Contract {
  id              String          @id @default(cuid())
  officeId        String
  // fileId is unique — one contract per file
  fileId          String          @unique
  finalizedById   String
  // Copied from the file at finalization time for archival integrity
  transactionType TransactionType
  // Final agreed price used as the basis for commission calculation.
  // BigInt — Iranian real estate prices exceed PostgreSQL INTEGER's ~2.1B Toman limit.
  finalPrice       BigInt
  // Commission breakdown — all amounts in Toman
  commissionAmount BigInt
  agentShare       BigInt
  officeShare      BigInt
  notes           String?
  finalizedAt     DateTime        @default(now())
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  office       Office       @relation(fields: [officeId], references: [id])
  file         PropertyFile @relation(fields: [fileId], references: [id])
  finalizedBy  User         @relation("FinalizedContracts", fields: [finalizedById], references: [id])

  @@index([officeId])
  @@map("contracts")
}

// Each share action creates a new unique link with its own price and view counter.
model ShareLink {
  id          String       @id @default(cuid())
  fileId      String
  createdById String
  token       String       @unique
  // If null, shows the file's current price. If set, shows this custom price.
  customPrice Int?
  viewCount   Int          @default(0)
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())

  file        PropertyFile @relation(fields: [fileId], references: [id], onDelete: Cascade)
  createdBy   User         @relation(fields: [createdById], references: [id])

  @@index([token])
  @@map("share_links")
}

// Per-user notification record. Created server-side on key events.
model Notification {
  id        String        @id @default(cuid())
  userId    String
  // FILE_ASSIGNED | FILE_EDITED
  type      String
  title     String
  message   String
  read      Boolean       @default(false)
  // Optional deep-link to the relevant file
  fileId    String?
  createdAt DateTime      @default(now())

  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  file      PropertyFile? @relation(fields: [fileId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([userId, read])
  @@map("notifications")
}
